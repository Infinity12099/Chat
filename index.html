<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CHAT</title>
    <style>
        :root { --bg-color: #f0f0f0; --chat-bg: white; --text-color: black; --received-msg: #e5e5ea; --input-bg: rgba(255,255,255,0.95); --border-color: #ddd; --header-bg: white; }
        body.dark-mode { --bg-color: #121212; --chat-bg: #1e1e1e; --text-color: #ffffff; --received-msg: #3a3a3c; --input-bg: rgba(30,30,30,0.95); --border-color: #333; --header-bg: #1e1e1e; }
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; width: 100%; position: fixed; background: var(--bg-color); color: var(--text-color); font-family: -apple-system, system-ui, sans-serif; }
        body { display: flex; flex-direction: column; }
        
        header { padding: 10px 15px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 10; flex-shrink: 0; padding-top: env(safe-area-inset-top); }
        
        #sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: var(--chat-bg); box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 1500; transition: 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; }
        #sidebar.open { left: 0; }
        #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1400; }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; margin-bottom: 5px; }
        .sent { align-self: flex-end; }
        .received { align-self: flex-start; }
        
        .msg { padding: 8px 12px; border-radius: 18px; word-wrap: break-word; font-size: 15px; cursor: pointer; position: relative; }
        .sent .msg { background: #007aff; color: white; border-bottom-right-radius: 2px; }
        .received .msg { background: var(--received-msg); color: var(--text-color); border-bottom-left-radius: 2px; }
        
        .input-area { padding: 10px; background: var(--input-bg); border-top: 1px solid var(--border-color); display: flex; align-items: center; flex-shrink: 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #message-input { flex: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; background: var(--chat-bg); color: var(--text-color); font-size: 16px; margin: 0 8px; -webkit-appearance: none; }
        
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-color); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .auth-card { background: var(--chat-bg); padding: 30px; border-radius: 25px; width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 10px; }
        
        #context-menu { position: fixed; display: none; background: var(--chat-bg); border: 1px solid var(--border-color); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 2000; width: 170px; overflow: hidden; }
        .menu-item { padding: 12px 15px; font-size: 14px; cursor: pointer; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
    </style>
</head>
<body>

<div id="sidebar-overlay"></div>
<div id="sidebar">
    <h2 style="margin-top:0;">Men√º</h2>
    <button id="logout-btn" style="margin-top:auto; background:#ff3b30; color:white; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer;">üö™ Abmelden</button>
</div>

<header>
    <button id="open-menu" style="background:none; border:none; font-size:24px; color:var(--text-color); cursor:pointer;">‚ò∞</button>
    <strong id="display-name">CHAT</strong>
    <button id="dark-btn" style="background:none; border:none; font-size:20px; cursor:pointer;">üåì</button>
</header>

<div id="auth-overlay">
    <div class="auth-card">
        <h2>Login</h2>
        <input type="text" id="auth-user" placeholder="Name" ontouchstart="this.focus()">
        <input type="password" id="auth-pass" placeholder="Passwort" ontouchstart="this.focus()">
        <button id="login-submit" style="padding:12px; background:#007aff; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">Anmelden</button>
    </div>
</div>

<div id="chat-window"></div>

<div class="input-area">
    <button id="img-btn" style="background:none; border:none; font-size:22px; cursor:pointer;">üñºÔ∏è</button>
    <input type="text" id="message-input" placeholder="Nachricht..." autocomplete="off" ontouchstart="this.focus()">
    <button id="send-btn" style="background:#007aff; color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;">‚ûî</button>
</div>

<div id="context-menu">
    <div class="menu-item" id="menu-del-btn" style="color:red;">üóëÔ∏è L√∂schen</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCcXbYcAGOZN1hecccLLNMTIox-L_s-hXY",
        authDomain: "meinsmschat.firebaseapp.com",
        projectId: "meinsmschat",
        storageBucket: "meinsmschat.firebasestorage.app",
        messagingSenderId: "197306165640",
        appId: "1:197306165640:web:c3748c70a76a36056e723d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let myName = localStorage.getItem("chat-user-logged");
    let selId = null;

    // LOGIN LOGIK MIT FEHLER-CHECK
    document.getElementById("login-submit").addEventListener("click", async () => {
        try {
            const n = document.getElementById("auth-user").value.trim().toLowerCase();
            const p = btoa(document.getElementById("auth-pass").value.trim());
            if(!n) return;
            const s = await getDoc(doc(db, "users", n));
            if(s.exists() && s.data().password === p) {
                localStorage.setItem("chat-user-logged", n);
                location.reload();
            } else { alert("Login fehlgeschlagen!"); }
        } catch (e) { alert("Fehler: " + e.message); }
    });

    if (myName) {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("display-name").textContent = myName.toUpperCase();

        onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(40)), (snap) => {
            const win = document.getElementById("chat-window");
            win.innerHTML = "";
            let ms = []; snap.forEach(d => ms.push({id: d.id, ...d.data()}));
            ms.reverse().forEach(m => {
                const wrap = document.createElement("div");
                wrap.className = `msg-wrapper ${m.user === myName ? 'sent' : 'received'}`;
                const time = m.createdAt ? m.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                
                const msgDiv = document.createElement("div");
                msgDiv.className = "msg";
                msgDiv.innerHTML = `${m.text || ''}<div style="font-size:8px; text-align:right; opacity:0.6;">${time}</div>`;
                
                // Kontextmen√º-Trigger f√ºr iPad
                msgDiv.addEventListener("contextmenu", (e) => { e.preventDefault(); showMenu(e, m.id); });
                let timer;
                msgDiv.addEventListener("touchstart", (e) => { timer = setTimeout(() => showMenu(e, m.id), 600); });
                msgDiv.addEventListener("touchend", () => clearTimeout(timer));

                wrap.innerHTML = `<small style="font-size:9px; opacity:0.5; margin-left:5px;">${m.user}</small>`;
                wrap.appendChild(msgDiv);
                win.appendChild(wrap);
            });
            win.scrollTop = win.scrollHeight;
        });
    }

    function showMenu(e, id) {
        selId = id;
        const menu = document.getElementById("context-menu");
        menu.style.display = "block";
        const x = e.pageX || (e.touches ? e.touches[0].pageX : 0);
        const y = e.pageY || (e.touches ? e.touches[0].pageY : 0);
        menu.style.left = x + "px";
        menu.style.top = y + "px";
    }

    const sendMsg = async () => {
        try {
            const inp = document.getElementById("message-input");
            if(!inp.value.trim()) return;
            await addDoc(collection(db, "messages"), { text: inp.value, user: myName, createdAt: serverTimestamp() });
            inp.value = "";
        } catch (e) { alert("Senden fehlgeschlagen!"); }
    };

    // Event Listener statt onclick im HTML (sicherer f√ºr iPad)
    document.getElementById("send-btn").addEventListener("click", sendMsg);
    document.getElementById("menu-del-btn").addEventListener("click", async () => {
        if(confirm("L√∂schen?")) { await deleteDoc(doc(db, "messages", selId)); }
        document.getElementById("context-menu").style.display = "none";
    });
    
    document.getElementById("message-input").onkeydown = (e) => { if(e.key === "Enter") sendMsg(); };
    document.getElementById("open-menu").onclick = () => { document.getElementById("sidebar").classList.add("open"); document.getElementById("sidebar-overlay").style.display = "block"; };
    document.getElementById("sidebar-overlay").onclick = () => { document.getElementById("sidebar").classList.remove("open"); document.getElementById("sidebar-overlay").style.display = "none"; };
    document.getElementById("logout-btn").onclick = () => { localStorage.clear(); location.reload(); };
    document.body.onclick = (e) => { if(!e.target.closest('#context-menu')) document.getElementById("context-menu").style.display="none"; };
</script>
</body>
</html>
