<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Supabase Chat Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --bg-color: #f0f0f0; --chat-bg: white; --text-color: black; --received-msg: #e5e5ea; --input-bg: rgba(255,255,255,0.95); --border-color: #ddd; --header-bg: white; --online-color: #4cd964; }
        body.dark-mode { --bg-color: #121212; --chat-bg: #1e1e1e; --text-color: #ffffff; --received-msg: #3a3a3c; --input-bg: rgba(30,30,30,0.95); --border-color: #333; --header-bg: #1e1e1e; }
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; width: 100%; position: fixed; background: var(--bg-color); color: var(--text-color); font-family: -apple-system, system-ui, sans-serif; transition: background 0.3s; }
        body { display: flex; flex-direction: column; }
        
        header { padding: 10px 15px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 10; padding-top: env(safe-area-inset-top); }
        
        #sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: var(--chat-bg); box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 1500; transition: 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; color: var(--text-color); }
        #sidebar.open { left: 0; }
        #sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1400; }
        
        .user-list { flex: 1; overflow-y: auto; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .user-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; font-size: 14px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: gray; }
        .status-dot.online { background: var(--online-color); box-shadow: 0 0 5px var(--online-color); }

        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .date-separator { text-align: center; margin: 20px 0; }
        .date-separator span { background: #cfd8dc; color: #546e7a; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        body.dark-mode .date-separator span { background: #37474f; color: #b0bec5; }

        .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; }
        .sent { align-self: flex-end; }
        .received { align-self: flex-start; }
        
        .msg { padding: 8px 12px; border-radius: 18px; word-wrap: break-word; font-size: 15px; position: relative; min-width: 80px; }
        .sent .msg { background: #007aff; color: white; border-bottom-right-radius: 2px; }
        .received .msg { background: var(--received-msg); color: var(--text-color); border-bottom-left-radius: 2px; }
        
        .msg-info { font-size: 10px; opacity: 0.8; text-align: right; margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }
        .sent .msg-info { color: rgba(255,255,255,0.9); }

        .input-area { padding: 10px; background: var(--input-bg); border-top: 1px solid var(--border-color); display: flex; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #message-input { flex: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; background: var(--chat-bg); color: var(--text-color); font-size: 16px; margin: 0 8px; }
        
        #auth-overlay { position: fixed; inset: 0; background: var(--bg-color); display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .auth-card { background: var(--chat-bg); padding: 30px; border-radius: 25px; width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 10px; text-align: center; color: var(--text-color); }
        .hidden-input { display: none; }
    </style>
</head>
<body class="">

<div id="auth-overlay">
    <div class="auth-card">
        <h2>Login</h2>
        <input type="text" id="auth-user" placeholder="Name" style="padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--chat-bg); color:var(--text-color);">
        <input type="password" id="auth-pass" placeholder="Passwort" style="padding:10px; border-radius:8px; border:1px solid var(--border-color); background:var(--chat-bg); color:var(--text-color);">
        <button id="login-submit" style="padding:12px; background:#007aff; color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">Anmelden</button>
        <button id="register-submit" style="background:none; border:none; color:#007aff; font-size:12px; cursor:pointer;">Konto erstellen</button>
    </div>
</div>

<div id="sidebar-overlay"></div>
<div id="sidebar">
    <h2 style="margin-top:0;">Men√º</h2>
    <p>Nutzer: <b id="user-info"></b></p>
    <div class="user-list" id="user-list-container"></div>
    <button id="dark-btn" style="width:100%; padding:12px; margin-top:10px; border-radius:10px; border:1px solid var(--border-color); background:var(--chat-bg); color:var(--text-color); cursor:pointer;">üåì Dark Mode umschalten</button>
    <button id="logout-btn" style="margin-top:auto; background:#ff3b30; color:white; border:none; padding:15px; border-radius:10px; font-weight:bold; cursor:pointer;">üö™ Abmelden</button>
</div>

<header>
    <button id="open-menu" style="background:none; border:none; font-size:24px; color:var(--text-color); cursor:pointer;">‚ò∞</button>
    <strong>Chat</strong>
    <div style="width:24px;"></div>
</header>

<div id="chat-window"></div>

<div class="input-area">
    <input type="file" id="file-input" class="hidden-input" accept="image/*">
    <button id="img-btn" style="background:none; border:none; font-size:22px; cursor:pointer;">üñºÔ∏è</button>
    <input type="text" id="message-input" placeholder="Nachricht..." autocomplete="off">
    <button id="send-btn" style="background:#007aff; color:white; border:none; border-radius:50%; width:40px; height:40px; cursor:pointer;">‚ûî</button>
</div>

<script>
    const SUPABASE_URL = 'https://aqlkpkdmzwhmukryvigk.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_CaIdN7zkaj1Yn6IZsUGMzg_5zjT6TBD';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myName = localStorage.getItem("chat-user-logged");

    // --- DATUM FORMATIEREN ---
    function formatChatDate(dateStr) {
        const now = new Date();
        const msgDate = new Date(dateStr);
        if (msgDate.toDateString() === now.toDateString()) return "Heute";
        const yesterday = new Date(); yesterday.setDate(now.getDate() - 1);
        if (msgDate.toDateString() === yesterday.toDateString()) return "Gestern";
        return msgDate.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // --- LOGIN ---
    document.getElementById("login-submit").onclick = async () => {
        const n = document.getElementById("auth-user").value.trim().toLowerCase();
        const p = btoa(document.getElementById("auth-user").parentElement.querySelector('input[type="password"]').value.trim());
        const { data } = await _supabase.from('profiles').select('*').eq('username', n).single();
        if(data && data.password === p) { localStorage.setItem("chat-user-logged", n); location.reload(); } else alert("Falscher Name oder Passwort!");
    };

    document.getElementById("register-submit").onclick = async () => {
        const n = document.getElementById("auth-user").value.trim().toLowerCase();
        const p = btoa(document.getElementById("auth-pass").value.trim());
        const { error } = await _supabase.from('profiles').insert([{ username: n, password: p, is_online: true }]);
        if(!error) alert("Konto erstellt! Bitte anmelden."); else alert("Fehler!");
    };

    // --- CHAT LOGIK ---
    if(myName) {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("user-info").textContent = myName.toUpperCase();
        
        // Status auf Online setzen
        _supabase.from('profiles').update({ is_online: true, last_seen: new Date().toISOString() }).eq('username', myName);

        loadMessages();
        loadUserList();

        _supabase.channel('room1')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, loadMessages)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, loadUserList)
            .subscribe();
    }

    async function loadUserList() {
        const { data } = await _supabase.from('profiles').select('username, is_online, last_seen').order('is_online', { ascending: false });
        const container = document.getElementById("user-list-container");
        container.innerHTML = "<h4>Nutzer online</h4>";
        data.forEach(user => {
            const item = document.createElement("div");
            item.className = "user-item";
            const time = new Date(user.last_seen).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            item.innerHTML = `<div class="status-dot ${user.is_online ? 'online' : ''}"></div>
                <span>${user.username} ${user.is_online ? '' : '<small style="opacity:0.5;">(Ab '+time+')</small>'}</span>`;
            container.appendChild(item);
        });
    }

    async function loadMessages() {
        const { data } = await _supabase.from('messages').select('*').order('created_at', { ascending: true });
        const win = document.getElementById("chat-window");
        win.innerHTML = "";
        let lastDate = "";

        data.forEach(m => {
            const dateObj = new Date(m.created_at);
            const dateLabel = dateObj.toDateString();
            
            if (dateLabel !== lastDate) {
                const sep = document.createElement("div");
                sep.className = "date-separator";
                sep.innerHTML = `<span>${formatChatDate(m.created_at)}</span>`;
                win.appendChild(sep);
                lastDate = dateLabel;
            }

            const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const wrap = document.createElement("div");
            wrap.className = `msg-wrapper ${m.user_name === myName ? 'sent' : 'received'}`;
            wrap.innerHTML = `
                <small style="font-size:10px; opacity:0.5; margin:0 5px;">${m.user_name}</small>
                <div class="msg">
                    ${m.image_url ? `<img src="${m.image_url}" style="max-width:100%; border-radius:10px; display:block; margin-bottom:5px;">` : ''}
                    ${m.text || ''}
                    <div class="msg-info">${time} ${m.user_name === myName ? '‚úì‚úì' : ''}</div>
                </div>`;
            win.appendChild(wrap);
        });
        win.scrollTop = win.scrollHeight;
    }

    // --- ACTIONS ---
    async function send() {
        const input = document.getElementById("message-input");
        if(!input.value.trim()) return;
        await _supabase.from('messages').insert([{ text: input.value, user_name: myName }]);
        input.value = "";
    }

    document.getElementById("send-btn").onclick = send;
    document.getElementById("message-input").onkeydown = (e) => { if(e.key === "Enter") send(); };
    document.getElementById("img-btn").onclick = () => document.getElementById("file-input").click();
    
    document.getElementById("file-input").onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const name = Date.now() + "_" + file.name;
        const { data } = await _supabase.storage.from('chat-images').upload(name, file);
        if(data) {
            const { data: url } = _supabase.storage.from('chat-images').getPublicUrl(name);
            await _supabase.from('messages').insert([{ image_url: url.publicUrl, user_name: myName, text: "" }]);
        }
    };

    // UI & DARKMODE
    document.getElementById("open-menu").onclick = () => { document.getElementById("sidebar").classList.add("open"); document.getElementById("sidebar-overlay").style.display = "block"; };
    document.getElementById("sidebar-overlay").onclick = () => { document.getElementById("sidebar").classList.remove("open"); document.getElementById("sidebar-overlay").style.display = "none"; };
    document.getElementById("dark-btn").onclick = () => document.body.classList.toggle("dark-mode");
    document.getElementById("logout-btn").onclick = async () => {
        await _supabase.from('profiles').update({ is_online: false }).eq('username', myName);
        localStorage.clear(); location.reload();
    };
</script>
</body>
</html>
