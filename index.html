<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SMS Chat Pro - Secure</title>
    <style>
        :root { --bg-color: #f0f0f0; --chat-bg: white; --text-color: black; --received-msg: #e5e5ea; --input-bg: rgba(255,255,255,0.95); --border-color: #ddd; --header-bg: white; }
        body.dark-mode { --bg-color: #121212; --chat-bg: #1e1e1e; --text-color: #ffffff; --received-msg: #3a3a3c; --input-bg: rgba(30,30,30,0.95); --border-color: #333; --header-bg: #1e1e1e; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; width: 100%; position: fixed; background: var(--bg-color); color: var(--text-color); }
        body { font-family: -apple-system, system-ui, sans-serif; display: flex; flex-direction: column; }
        header { padding: 10px 15px; background: var(--header-bg); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); z-index: 10; flex-shrink: 0; padding-top: env(safe-area-inset-top); }
        #sidebar { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: var(--chat-bg); box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 1000; transition: 0.3s; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; overflow-y: auto; color: var(--text-color); }
        #sidebar.open { left: 0; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
        .admin-box { display: none; background: rgba(255, 149, 0, 0.1); border: 1px solid #ff9500; border-radius: 10px; padding: 12px; margin-top: 15px; }
        .status-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        #archive-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1100; display: none; flex-direction: column; }
        #archive-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; }
        .msg { padding: 8px 12px; border-radius: 18px; max-width: 80%; word-wrap: break-word; font-size: 15px; display: flex; flex-direction: column; }
        .sent { background: #007aff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: var(--received-msg); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 2px; }
        #typing-indicator { font-size: 11px; padding: 5px 15px; color: #8e8e93; font-style: italic; height: 15px; }
        .input-area { padding: 10px; background: var(--input-bg); border-top: 1px solid var(--border-color); display: flex; align-items: center; flex-shrink: 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #message-input { flex: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; outline: none; background: var(--chat-bg); color: var(--text-color); font-size: 16px; margin: 0 8px; }
        #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .auth-card { background: var(--chat-bg); padding: 30px; border-radius: 25px; width: 85%; max-width: 300px; display: flex; flex-direction: column; gap: 10px; }
        .btn-blue { width: 100%; padding: 12px; background: #007aff; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-small { padding: 5px 10px; font-size: 11px; border-radius: 5px; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="sidebar-overlay"></div>
<div id="sidebar">
    <h2 style="margin-top:0;">Men√º</h2>
    <button id="archive-btn" class="btn-blue">üì¶ Archiv √∂ffnen</button>
    <div id="admin-section" class="admin-box">
        <strong style="color:#ff9500; font-size:12px;">ADMIN CONTROL</strong>
        <div id="delete-status-label" class="status-badge"></div>
        <button id="toggle-delete-btn" class="btn-small" style="width:100%; background:#ff9500; color:white; margin-top:10px; font-weight:bold;">L√ñSCHEN UMSCHALTEN</button>
        <div style="margin-top:15px; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px;">
            <p style="font-size:11px; margin:0;">Nutzer freischalten:</p>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="new-user-name" placeholder="Name" style="width:70%; padding:5px; border-radius:5px; border:1px solid #ddd;">
                <button id="add-user-btn" class="btn-small" style="background:#4cd964; color:white;">+</button>
            </div>
            <div id="allowed-list-display" style="font-size:11px; margin-top:8px; max-height:100px; overflow-y:auto;"></div>
        </div>
    </div>
    <div style="margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;"><strong>Status</strong><div id="status-container"></div></div>
    <button id="logout-btn-sidebar" style="margin-top:auto; background:#ff3b30; border:none; color:white; font-weight:bold; cursor:pointer; padding:15px; border-radius:10px;">üö™ Abmelden</button>
</div>

<div id="archive-overlay">
    <header><button id="close-archive" style="background:none; border:none; font-size:16px; color:#007aff; font-weight:bold;">‚Üê Zur√ºck</button><strong>Archiv</strong><div style="width:50px;"></div></header>
    <div id="archive-content"></div>
</div>

<header>
    <button style="background:none; border:none; font-size:24px; color:var(--text-color);" id="open-menu">‚ò∞</button>
    <strong id="display-name">CHAT</strong>
    <button id="darkmode-btn" style="background:none; border:none; font-size:20px;">üåì</button>
</header>

<div id="auth-overlay">
    <div class="auth-card">
        <h2>Login</h2>
        <input type="text" id="auth-user" placeholder="Name">
        <input type="password" id="auth-pass" placeholder="Passwort">
        <button id="login-submit" class="btn-blue">Anmelden</button>
        <button id="register-submit" style="background:none; border:none; color:#007aff; font-size:12px; cursor:pointer;">Konto erstellen</button>
    </div>
</div>

<div id="chat-window"></div>
<div id="typing-indicator"></div>

<div class="input-area">
    <button id="img-btn" style="background:none; border:none; font-size:22px;">üñºÔ∏è</button>
    <input type="text" id="message-input" placeholder="Nachricht..." autocomplete="off">
    <button id="send-btn" style="background:#007aff; color:white; border:none; border-radius:50%; width:40px; height:40px;">‚ûî</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getDatabase, ref, set, onValue, onDisconnect, serverTimestamp as rtdbTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCcXbYcAGOZN1hecccLLNMTIox-L_s-hXY",
        authDomain: "meinsmschat.firebaseapp.com",
        projectId: "meinsmschat",
        storageBucket: "meinsmschat.firebasestorage.app",
        messagingSenderId: "197306165640",
        appId: "1:197306165640:web:c3748c70a76a36056e723d",
        databaseURL: "https://meinsmschat-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    let myName = localStorage.getItem("chat-user-logged");
    let deleteAllowed = true;

    // --- DARKMODE ---
    const toggleDark = (isDark) => { document.body.classList.toggle("dark-mode", isDark); localStorage.setItem("theme", isDark ? "dark" : "light"); };
    if (localStorage.getItem("theme") === "dark") toggleDark(true);
    document.getElementById("darkmode-btn").onclick = () => toggleDark(!document.body.classList.contains("dark-mode"));

    // --- SIDEBAR & MENU ---
    document.getElementById("open-menu").onclick = () => { document.getElementById("sidebar").classList.add("open"); document.getElementById("sidebar-overlay").style.display = "block"; };
    document.getElementById("sidebar-overlay").onclick = () => { document.getElementById("sidebar").classList.remove("open"); document.getElementById("sidebar-overlay").style.display = "none"; };

    // --- STATUS ---
    if (myName) {
        set(ref(rtdb, 'status/' + myName), { online: true, lastSeen: rtdbTimestamp() });
        onDisconnect(ref(rtdb, 'status/' + myName)).set({ online: false, lastSeen: rtdbTimestamp() });
        document.getElementById("message-input").oninput = () => {
            setDoc(doc(db, "typing", "status"), { [myName]: true }, { merge: true });
            clearTimeout(window.tTimer);
            window.tTimer = setTimeout(() => setDoc(doc(db, "typing", "status"), { [myName]: false }, { merge: true }), 2000);
        };
    }

    // --- REGISTRIERUNG & LOGIN (SICHERHEIT) ---
    const getAllowed = async () => {
        const s = await getDoc(doc(db, "settings", "allowedUsers"));
        return s.exists() ? s.data().names : ["infinity", "ozean"];
    };

    document.getElementById("register-submit").onclick = async () => {
        const n = document.getElementById("auth-user").value.trim().toLowerCase();
        const p = document.getElementById("auth-pass").value.trim();
        if(!n || !p) return alert("Felder ausf√ºllen!");
        
        const allowed = await getAllowed();
        if(!allowed.includes(n)) return alert("Admin muss dich erst freischalten!");
        
        const userDoc = await getDoc(doc(db, "users", n));
        if(userDoc.exists()) return alert("Account existiert bereits! Bitte logge dich normal ein.");
        
        await setDoc(doc(db, "users", n), { password: btoa(p) });
        alert("Account erstellt! Du kannst dich jetzt einloggen.");
    };

    document.getElementById("login-submit").onclick = async () => {
        const n = document.getElementById("auth-user").value.trim().toLowerCase();
        const p = btoa(document.getElementById("auth-pass").value.trim());
        const userDoc = await getDoc(doc(db, "users", n));
        if(userDoc.exists() && userDoc.data().password === p) {
            localStorage.setItem("chat-user-logged", n);
            location.reload();
        } else alert("Passwort oder Name falsch!");
    };

    document.getElementById("logout-btn-sidebar").onclick = async () => {
        if(myName) await set(ref(rtdb, 'status/' + myName), { online: false, lastSeen: rtdbTimestamp() });
        localStorage.clear(); location.reload();
    };

    // --- ADMIN & CHAT LOGIK ---
    onSnapshot(doc(db, "settings", "global"), (s) => {
        if(s.exists()) {
            deleteAllowed = s.data().deleteAllowed;
            const label = document.getElementById("delete-status-label");
            label.textContent = deleteAllowed ? "L√ñSCHEN: AKTIV" : "L√ñSCHEN: GESPERRT";
            label.style.background = deleteAllowed ? "#4cd964" : "#ff3b30";
            label.style.color = "white";
        }
    });

    onSnapshot(doc(db, "settings", "allowedUsers"), (docSnap) => {
        const allowed = docSnap.exists() ? docSnap.data().names : ["infinity", "ozean"];
        onValue(ref(rtdb, 'status'), (snapshot) => {
            const container = document.getElementById("status-container");
            container.innerHTML = "";
            const statusData = snapshot.val() || {};
            allowed.forEach(user => {
                const data = statusData[user] || { online: false, lastSeen: null };
                const isOnline = data.online === true;
                const date = data.lastSeen ? new Date(data.lastSeen).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "";
                container.innerHTML += `<div style="margin:8px 0; font-size:13px;"><span style="height:8px; width:8px; border-radius:50%; display:inline-block; margin-right:5px; background:${isOnline?'#4cd964':'#8e8e93'}"></span><b>${user.toUpperCase()}</b> <span style="font-size:10px; opacity:0.5;">${isOnline ? 'online' : 'Zuletzt: '+date}</span></div>`;
            });
        });
        if (myName === "infinity") {
            document.getElementById("admin-section").style.display = "block";
            document.getElementById("allowed-list-display").innerHTML = allowed.map(u => `<div>‚Ä¢ ${u} <span style="color:red; cursor:pointer;" onclick="window.removeUser('${u}')">√ó</span></div>`).join("");
        }
    });

    if (myName === "infinity") {
        document.getElementById("add-user-btn").onclick = async () => {
            const name = document.getElementById("new-user-name").value.trim().toLowerCase();
            const allowed = await getAllowed();
            if(name && !allowed.includes(name)) { 
                allowed.push(name); 
                await setDoc(doc(db, "settings", "allowedUsers"), { names: allowed }); 
            }
            document.getElementById("new-user-name").value = "";
        };
        window.removeUser = async (n) => {
            const allowed = await getAllowed();
            await setDoc(doc(db, "settings", "allowedUsers"), { names: allowed.filter(u => u !== n) });
        };
        document.getElementById("toggle-delete-btn").onclick = () => setDoc(doc(db, "settings", "global"), { deleteAllowed: !deleteAllowed }, { merge: true });
    }

    // --- ARCHIV ---
    document.getElementById("archive-btn").onclick = async () => {
        document.getElementById("archive-overlay").style.display = "flex";
        const content = document.getElementById("archive-content");
        content.innerHTML = "Lade Nachrichten...";
        const snap = await getDocs(query(collection(db, "messages"), orderBy("createdAt", "asc")));
        content.innerHTML = "";
        snap.forEach(d => {
            const m = d.data();
            const div = document.createElement("div");
            div.className = `msg ${m.user === myName ? 'sent' : 'received'}`;
            div.innerHTML = `<small style="font-size:9px;">${m.user}</small><div>${m.imageUrl ? `<img src="${m.imageUrl}" style="max-width:100%; border-radius:10px;"><br>` : ''}${m.text || ''}</div>`;
            content.appendChild(div);
        });
        content.scrollTop = content.scrollHeight;
    };
    document.getElementById("close-archive").onclick = () => document.getElementById("archive-overlay").style.display = "none";

    // --- CHAT DISPLAY ---
    if (myName) {
        document.getElementById("auth-overlay").style.display = "none";
        document.getElementById("display-name").textContent = myName.toUpperCase();
        onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(30)), (snap) => {
            const win = document.getElementById("chat-window");
            win.innerHTML = ""; const msgs = []; snap.forEach(d => msgs.push({id: d.id, ...d.data()}));
            msgs.reverse().forEach(m => {
                const div = document.createElement("div"); div.className = `msg ${m.user === myName ? 'sent' : 'received'}`;
                const time = m.createdAt ? m.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                div.innerHTML = `<small style="font-size:9px; opacity:0.7;">${m.user}</small><div>${m.imageUrl ? `<img src="${m.imageUrl}" style="max-width:100%; border-radius:10px;"><br>` : ''}${m.text || ''} <span style="font-size:8px; opacity:0.5; margin-left:5px;">${time}</span></div>`;
                div.onclick = async () => { if(m.user === myName && (deleteAllowed || myName === "infinity") && confirm("L√∂schen?")) await deleteDoc(doc(db, "messages", m.id)); };
                win.appendChild(div);
            });
            win.scrollTop = win.scrollHeight;
        });
        
        onSnapshot(doc(db, "typing", "status"), (s) => {
            if(!s.exists()) return;
            const typing = Object.keys(s.data()).filter(u => s.data()[u] === true && u !== myName);
            document.getElementById("typing-indicator").textContent = typing.length ? typing.join(", ") + " schreibt..." : "";
        });
    }

    const send = async (t, i = null) => {
        if(!t && !i) return;
        await addDoc(collection(db, "messages"), { text:t, imageUrl:i, user:myName, createdAt:serverTimestamp() });
        document.getElementById("message-input").value = "";
    };
    document.getElementById("send-btn").onclick = () => send(document.getElementById("message-input").value);
    document.getElementById("message-input").onkeydown = (e) => { if(e.key === "Enter") send(e.target.value); };
    document.getElementById("img-btn").onclick = () => { const u = prompt("Bild-Link:"); if(u) send("", u); };
</script>
</body>
</html>
